<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGod - Messaging</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/messaging/messaging_styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/emoji-mart@5.6.0/css/emoji-mart.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@5.6.0/dist/emoji-mart.js"></script>
    <style>
        /* Ensure buttons are clickable and responsive */
        .chat-item, .group-item, .tab, .emoji-btn, .plus-btn, .send-btn {
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        /* Ensure chat area and chatting page are visible when needed */
        .chat-area, .chatting-page-mobile {
            display: none; /* Initially hidden */
        }

        .chat-area:not(.hidden), .chatting-page-mobile:not(.hidden) {
            display: flex !important; /* Show when hidden class is removed */
        }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            .chat-item, .group-item {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            .tab {
                font-size: 14px !important;
                padding: 8px !important;
            }
            .chat-input button {
                padding: 8px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <header class="bg-gray-800 p-4 flex justify-between items-center fixed top-0 left-0 right-0 z-10">
        <div class="hamburger cursor-pointer">
            <span class="block w-6 h-1 bg-white mb-1"></span>
            <span class="block w-6 h-1 bg-white mb-1"></span>
            <span class="block w-6 h-1 bg-white"></span>
        </div>
        <h1 class="text-2xl font-bold text-neon-green">X07</h1>
        <a href="{{ url_for('profile') }}">
            {% if current_user.profile_pic %}
                <img src="{{ url_for('uploaded_file', filename='profile_pics/' + current_user.profile_pic) }}" alt="Profile Picture" class="w-10 h-10 rounded-full">
            {% else %}
                <img src="{{ url_for('static', filename='images/default_profile.jpg') }}" alt="Default Profile Picture" class="w-10 h-10 rounded-full">
            {% endif %}
        </a>
    </header>

    <!-- Sidebar (Hidden by Default, Opens with Hamburger Menu) -->
    <div class="sidebar fixed top-0 left-0 h-full w-64 bg-gray-800 transform -translate-x-full transition-transform duration-300 ease-in-out z-20">
        <div class="p-4 mt-16">
            <h2 class="text-xl font-bold text-neon-green mb-4">Menu</h2>
            <ul class="space-y-2">
                <li><a href="{{ url_for('index') }}" class="text-white hover:text-neon-green">Home</a></li>
                <li><a href="{{ url_for('status') }}" class="text-white hover:text-neon-green">Status</a></li>
                <li><a href="{{ url_for('profile') }}" class="text-white hover:text-neon-green">Profile</a></li>
                <li><a href="{{ url_for('logout') }}" class="text-white hover:text-neon-green">Logout</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mt-16">
        <!-- PC Layout -->
        <div class="pc-layout flex h-[calc(100vh-64px)] hidden md:flex">
            <!-- Left Sidebar (Chat and Group Chat Options) -->
            <div class="sidebar-content w-1/2 bg-gray-800 p-4">
                <div class="tabs flex border-b-2 border-gray-600 mb-4">
                    <div class="tab flex-1 p-3 text-center cursor-pointer text-gray-400 font-bold transition-all duration-300 chat-tab active">Chats</div>
                    <div class="tab flex-1 p-3 text-center cursor-pointer text-gray-400 font-bold transition-all duration-300 group-tab">Group Chats</div>
                </div>

                <!-- Chat List (Registered Users) -->
                <div class="chat-list active">
                    {% for user in users %}
                        <div class="chat-item p-3 mb-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-all duration-200 flex items-center" data-id="{{ user.id }}" data-type="user">
                            {% if user.profile_pic %}
                                <img src="{{ url_for('uploaded_file', filename='profile_pics/' + user.profile_pic) }}" alt="Profile Picture" class="w-10 h-10 rounded-full mr-3">
                            {% else %}
                                <img src="{{ url_for('static', filename='images/default_profile.jpg') }}" alt="Default Profile Picture" class="w-10 h-10 rounded-full mr-3">
                            {% endif %}
                            <span class="text-white">{{ user.username }}</span>
                        </div>
                    {% endfor %}
                </div>

                <!-- Group List -->
                <div class="group-list hidden">
                    {% for group in groups %}
                        <div class="group-item p-3 mb-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-all duration-200 flex items-center" data-id="{{ group.id }}" data-type="group">
                            <img src="{{ url_for('static', filename='images/group_icon.png') }}" alt="Group Icon" class="w-10 h-10 rounded-full mr-3">
                            <span class="text-white">{{ group.name }} {% if group.is_channel %}(Channel){% endif %}</span>
                        </div>
                    {% endfor %}
                    <div class="group-item p-3 mb-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-all duration-200 flex items-center create-group">
                        <img src="{{ url_for('static', filename='images/group_icon.png') }}" alt="Add Group" class="w-10 h-10 rounded-full mr-3">
                        <span class="text-white">Create New Group</span>
                    </div>
                </div>
            </div>

            <!-- Chat Area (PC) -->
            <div class="chat-area flex-1 flex flex-col bg-gray-900 hidden" id="chat-area-pc">
                <div class="chat-header bg-gray-800 p-4 flex justify-between items-center border-b border-gray-600">
                    <div class="flex items-center gap-3">
                        <a href="{{ url_for('messaging') }}" class="text-neon-green"><i class="fas fa-arrow-left"></i></a>
                        <img id="chat-header-img" src="" alt="Profile Picture" class="w-10 h-10 rounded-full">
                        <h2 id="chat-header-name" class="text-lg text-neon-green"></h2>
                    </div>
                    <div class="relative">
                        <button class="text-neon-green"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="dropdown-menu absolute right-0 top-10 bg-gray-700 rounded-lg shadow-lg hidden">
                            <button onclick="muteChat()" class="block px-4 py-2 text-white hover:bg-gray-600 w-full text-left">Mute</button>
                            <button onclick="blockChat()" class="block px-4 py-2 text-white hover:bg-gray-600 w-full text-left">Block</button>
                        </div>
                    </div>
                </div>
                <div class="chat-messages flex-1 p-4 overflow-y-auto" id="chat-messages-pc"></div>
                <div class="chat-input bg-gray-800 p-4 border-t border-gray-600 flex items-center gap-3 relative">
                    <form id="message-form-pc" onsubmit="sendMessage(event)" class="flex-1 flex items-center gap-3">
                        <input type="hidden" id="receiver-id-pc">
                        <input type="hidden" id="group-id-pc">
                        <button type="button" class="emoji-btn text-neon-pink"><i class="fas fa-smile"></i></button>
                        <div class="emoji-panel absolute bottom-16 left-4 hidden" id="emoji-panel-pc"></div>
                        <input type="text" id="message-content-pc" placeholder="Type a message..." class="input-3d flex-1 p-3 border-none rounded-full bg-gray-700 text-white placeholder-gray-400">
                        <button type="button" class="plus-btn bg-gray-700 text-neon-green p-3 rounded-full hover:bg-gray-600"><i class="fas fa-plus"></i></button>
                        <button type="submit" class="send-btn bg-neon-green text-black p-3 rounded-full hover:bg-green-400 transition-all duration-200"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
            <div class="no-selection flex-1 flex justify-center items-center text-gray-400 text-lg">Select a chat or group to start messaging, bhai! ðŸ˜Ž</div>
        </div>

        <!-- Mobile Layout -->
        <div class="mobile-layout md:hidden">
            <!-- Chat List (Mobile) -->
            <div class="chat-list-mobile active">
                <div class="tabs flex border-b-2 border-gray-600 mb-4 px-4 pt-4">
                    <div class="tab flex-1 p-3 text-center cursor-pointer text-gray-400 font-bold transition-all duration-300 chat-tab-mobile active">Chats</div>
                    <div class="tab flex-1 p-3 text-center cursor-pointer text-gray-400 font-bold transition-all duration-300 group-tab-mobile">Group Chats</div>
                </div>
                <div class="chat-list-content">
                    {% for user in users %}
                        <div class="chat-item p-3 mb-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-all duration-200 flex items-center mx-4" data-id="{{ user.id }}" data-type="user">
                            {% if user.profile_pic %}
                                <img src="{{ url_for('uploaded_file', filename='profile_pics/' + user.profile_pic) }}" alt="Profile Picture" class="w-10 h-10 rounded-full mr-3">
                            {% else %}
                                <img src="{{ url_for('static', filename='images/default_profile.jpg') }}" alt="Default Profile Picture" class="w-10 h-10 rounded-full mr-3">
                            {% endif %}
                            <span class="text-white">{{ user.username }}</span>
                        </div>
                    {% endfor %}
                </div>
                <div class="group-list-content hidden">
                    {% for group in groups %}
                        <div class="group-item p-3 mb-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-all duration-200 flex items-center mx-4" data-id="{{ group.id }}" data-type="group">
                            <img src="{{ url_for('static', filename='images/group_icon.png') }}" alt="Group Icon" class="w-10 h-10 rounded-full mr-3">
                            <span class="text-white">{{ group.name }} {% if group.is_channel %}(Channel){% endif %}</span>
                        </div>
                    {% endfor %}
                    <div class="group-item p-3 mb-2 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition-all duration-200 flex items-center mx-4 create-group">
                        <img src="{{ url_for('static', filename='images/group_icon.png') }}" alt="Add Group" class="w-10 h-10 rounded-full mr-3">
                        <span class="text-white">Create New Group</span>
                    </div>
                </div>
            </div>

            <!-- Chatting Page (Mobile) -->
            <div class="chatting-page-mobile hidden h-[calc(100vh-64px)] flex flex-col bg-gray-900" id="chatting-page-mobile">
                <div class="chat-header bg-gray-800 p-4 flex justify-between items-center border-b border-gray-600">
                    <div class="flex items-center gap-3">
                        <button onclick="backToChatList()" class="text-neon-green"><i class="fas fa-arrow-left"></i></button>
                        <img id="chat-header-img-mobile" src="" alt="Profile Picture" class="w-10 h-10 rounded-full">
                        <h2 id="chat-header-name-mobile" class="text-lg text-neon-green"></h2>
                    </div>
                    <div class="relative">
                        <button class="text-neon-green"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="dropdown-menu absolute right-0 top-10 bg-gray-700 rounded-lg shadow-lg hidden">
                            <button onclick="muteChat()" class="block px-4 py-2 text-white hover:bg-gray-600 w-full text-left">Mute</button>
                            <button onclick="blockChat()" class="block px-4 py-2 text-white hover:bg-gray-600 w-full text-left">Block</button>
                        </div>
                    </div>
                </div>
                <div class="chat-messages flex-1 p-4 overflow-y-auto" id="chat-messages-mobile"></div>
                <div class="chat-input bg-gray-800 p-4 border-t border-gray-600 flex items-center gap-3 relative">
                    <form id="message-form-mobile" onsubmit="sendMessage(event)" class="flex-1 flex items-center gap-3">
                        <input type="hidden" id="receiver-id-mobile">
                        <input type="hidden" id="group-id-mobile">
                        <button type="button" class="emoji-btn text-neon-pink"><i class="fas fa-smile"></i></button>
                        <div class="emoji-panel absolute bottom-16 left-4 hidden" id="emoji-panel-mobile"></div>
                        <input type="text" id="message-content-mobile" placeholder="Type a message..." class="input-3d flex-1 p-3 border-none rounded-full bg-gray-700 text-white placeholder-gray-400">
                        <button type="button" class="plus-btn bg-gray-700 text-neon-green p-3 rounded-full hover:bg-gray-600"><i class="fas fa-plus"></i></button>
                        <button type="submit" class="send-btn bg-neon-green text-black p-3 rounded-full hover:bg-green-400 transition-all duration-200"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Link to Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>

    <!-- Inline JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded, initializing script...");

            // Initialize Socket.IO with polling transport and force new connection
            const socket = io({
                transports: ['polling', 'websocket'], // Start with polling, fallback to websocket
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                forceNew: true // Force a new connection to avoid session conflicts
            });

            socket.on('connect', () => {
                console.log("Socket.IO connected successfully with ID:", socket.id);
            });

            socket.on('connect_error', (error) => {
                console.error("Socket.IO connection error:", error);
            });

            socket.on('disconnect', () => {
                console.log("Socket.IO disconnected!");
            });

            const current_user_id = {{ current_user.id }};
            const usersList = {{ users_list | tojson }};
            const groupsList = {{ groups_list | tojson }};

            // Hamburger Menu Toggle
            const hamburger = document.querySelector('.hamburger');
            const sidebar = document.querySelector('.sidebar');
            if (hamburger && sidebar) {
                console.log("Hamburger and sidebar found, attaching event listener...");
                hamburger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Hamburger clicked!");
                    sidebar.classList.toggle('-translate-x-full');
                    hamburger.classList.toggle('active');
                });
            } else {
                console.error("Hamburger or sidebar not found!");
            }

            // Dropdown Menu Toggle
            document.querySelectorAll('.chat-header button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Dropdown button clicked!");
                    const dropdown = button.nextElementSibling;
                    if (dropdown) dropdown.classList.toggle('hidden');
                });
            });

            // Tab Switching (PC)
            const chatTab = document.querySelector('.chat-tab');
            const groupTab = document.querySelector('.group-tab');
            const chatList = document.querySelector('.chat-list');
            const groupList = document.querySelector('.group-list');

            if (chatTab && groupTab && chatList && groupList) {
                console.log("PC tabs found, attaching event listeners...");
                chatTab.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Chat tab clicked!");
                    chatTab.classList.add('active');
                    groupTab.classList.remove('active');
                    chatList.classList.remove('hidden');
                    groupList.classList.add('hidden');
                });

                groupTab.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Group tab clicked!");
                    groupTab.classList.add('active');
                    chatTab.classList.remove('active');
                    groupList.classList.remove('hidden');
                    chatList.classList.add('hidden');
                });
            } else {
                console.error("PC tabs not found!");
            }

            // Tab Switching (Mobile)
            const chatTabMobile = document.querySelector('.chat-tab-mobile');
            const groupTabMobile = document.querySelector('.group-tab-mobile');
            const chatListMobile = document.querySelector('.chat-list-content');
            const groupListMobile = document.querySelector('.group-list-content');

            if (chatTabMobile && groupTabMobile && chatListMobile && groupListMobile) {
                console.log("Mobile tabs found, attaching event listeners...");
                chatTabMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Chat tab mobile clicked!");
                    chatTabMobile.classList.add('active');
                    groupTabMobile.classList.remove('active');
                    chatListMobile.classList.remove('hidden');
                    groupListMobile.classList.add('hidden');
                });

                groupTabMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Group tab mobile clicked!");
                    groupTabMobile.classList.add('active');
                    chatTabMobile.classList.remove('active');
                    groupListMobile.classList.remove('hidden');
                    chatListMobile.classList.add('hidden');
                });
            } else {
                console.error("Mobile tabs not found!");
            }

            // Emoji Picker Setup
            const emojiBtnPc = document.querySelector('.emoji-btn');
            const emojiPanelPc = document.querySelector('#emoji-panel-pc');
            const messageInputPc = document.querySelector('#message-content-pc');
            const emojiBtnMobile = document.querySelector('#chatting-page-mobile .emoji-btn');
            const emojiPanelMobile = document.querySelector('#emoji-panel-mobile');
            const messageInputMobile = document.querySelector('#message-content-mobile');

            if (emojiBtnPc && emojiPanelPc && messageInputPc) {
                console.log("Setting up emoji picker for PC...");
                const pickerPc = new emojiMart.Picker({
                    onEmojiSelect: (emoji) => {
                        console.log("Emoji selected on PC:", emoji.native);
                        messageInputPc.value += emoji.native;
                        emojiPanelPc.classList.add('hidden');
                    }
                });
                emojiPanelPc.appendChild(pickerPc);

                emojiBtnPc.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Emoji button clicked on PC!");
                    emojiPanelPc.classList.toggle('hidden');
                });
            } else {
                console.error("Emoji picker elements for PC not found!");
            }

            if (emojiBtnMobile && emojiPanelMobile && messageInputMobile) {
                console.log("Setting up emoji picker for Mobile...");
                const pickerMobile = new emojiMart.Picker({
                    onEmojiSelect: (emoji) => {
                        console.log("Emoji selected on Mobile:", emoji.native);
                        messageInputMobile.value += emoji.native;
                        emojiPanelMobile.classList.add('hidden');
                    }
                });
                emojiPanelMobile.appendChild(pickerMobile);

                emojiBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Emoji button clicked on Mobile!");
                    emojiPanelMobile.classList.toggle('hidden');
                });
            } else {
                console.error("Emoji picker elements for Mobile not found!");
            }

            // Chat Functions (PC)
            function openChat(id, type) {
                console.log(`Attempting to open chat for ${type} with ID: ${id}`);
                const chatArea = document.querySelector('#chat-area-pc');
                const noSelection = document.querySelector('.no-selection');
                
                if (!chatArea || !noSelection) {
                    console.error("Chat area or no-selection element not found! Chat Area:", chatArea, "No Selection:", noSelection);
                    return;
                }

                // Ensure chat area is visible and no-selection is hidden
                console.log("Hiding no-selection and showing chat area...");
                noSelection.classList.add('hidden');
                chatArea.classList.remove('hidden');
                chatArea.dataset.chatId = id;
                chatArea.dataset.chatType = type;

                const headerImg = document.querySelector('#chat-header-img');
                const headerName = document.querySelector('#chat-header-name');
                const receiverIdInput = document.querySelector('#receiver-id-pc');
                const groupIdInput = document.querySelector('#group-id-pc');
                const messagesContainer = document.querySelector('#chat-messages-pc');

                if (!headerImg || !headerName || !receiverIdInput || !groupIdInput || !messagesContainer) {
                    console.error("Chat header elements or messages container not found! Header Img:", headerImg, "Header Name:", headerName, "Receiver ID:", receiverIdInput, "Group ID:", groupIdInput, "Messages Container:", messagesContainer);
                    return;
                }

                console.log("Setting chat header details...");
                if (type === 'user') {
                    const user = usersList.find(u => u.id == parseInt(id));
                    if (user) {
                        console.log("User found:", user);
                        headerImg.src = user.profile_pic ? `/uploads/profile_pics/${user.profile_pic}` : '/static/images/default_profile.jpg';
                        headerName.textContent = user.username;
                        receiverIdInput.value = id;
                        groupIdInput.value = '';
                    } else {
                        console.error(`User with ID ${id} not found in usersList:`, usersList);
                        return;
                    }
                } else {
                    const group = groupsList.find(g => g.id == parseInt(id));
                    if (group) {
                        console.log("Group found:", group);
                        headerImg.src = '/static/images/group_icon.png';
                        headerName.textContent = group.name + (group.is_channel ? ' (Channel)' : '');
                        receiverIdInput.value = '';
                        groupIdInput.value = id;
                    } else {
                        console.error(`Group with ID ${id} not found in groupsList:`, groupsList);
                        return;
                    }
                }

                console.log("Fetching messages from server...");
                fetch(`/messaging?${type === 'user' ? 'user_id' : 'group_id'}=${id}&chat_type=${type}`)
                    .then(response => {
                        console.log("Fetch response status:", response.status);
                        if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
                        return response.text();
                    })
                    .then(html => {
                        console.log('Fetched HTML:', html);
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const messages = doc.querySelectorAll('.message');
                        messagesContainer.innerHTML = ''; // Clear previous messages
                        console.log("Messages found:", messages.length);
                        if (messages.length > 0) {
                            messages.forEach(message => {
                                console.log("Processing message:", message);
                                const messageDiv = document.createElement('div');
                                messageDiv.classList.add('message', message.classList.contains('sent') ? 'sent' : 'received', 'mb-4', 'max-w-[70%]', 'p-3', 'rounded-lg', 'relative', 'transition-opacity', 'duration-300');
                                messageDiv.setAttribute('data-id', message.dataset.id || '');
                                const content = message.querySelector('div') ? message.querySelector('div').innerText : 'No content';
                                const timestamp = message.querySelector('.timestamp') ? message.querySelector('.timestamp').innerText : '';
                                messageDiv.innerHTML = `
                                    <div>${content}</div>
                                    <div class="timestamp text-xs text-gray-500 absolute bottom-[-1.5rem] right-2">${timestamp}${message.classList.contains('edited') ? ' (Edited)' : ''}</div>
                                    ${message.classList.contains('sent') ? `
                                        <div class="message-actions flex gap-2 mt-2 opacity-0 transition-opacity duration-300">
                                            <button onclick="editMessage(${message.dataset.id})" class="bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-500">Edit</button>
                                            <select onchange="setDisappearTimer(${message.dataset.id}, this.value)" class="bg-gray-600 text-white px-2 py-1 rounded">
                                                <option value="0">No Timer</option>
                                                <option value="10">10s</option>
                                                <option value="60">1min</option>
                                                <option value="3600">1hr</option>
                                            </select>
                                        </div>
                                    ` : ''}
                                `;
                                messagesContainer.appendChild(messageDiv);
                            });
                        } else {
                            console.log("No messages found, showing default message...");
                            messagesContainer.innerHTML = '<div class="text-gray-400 text-center">No messages yet, bhai! Start chatting! ðŸ˜Ž</div>';
                        }
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;

                        const room = groupIdInput.value ? `group_${groupIdInput.value}` : `chat_${Math.min(current_user_id, parseInt(receiverIdInput.value))}_${Math.max(current_user_id, parseInt(receiverIdInput.value))}`;
                        console.log(`Joining room: ${room}`);
                        socket.emit('join', { room: room });
                    })
                    .catch(error => {
                        console.error('Error fetching messages:', error.message);
                        messagesContainer.innerHTML = `<div class="text-red-500 text-center">Error loading messages, bhai! ðŸ˜… ${error.message}</div>`;
                    });
            }

            function openChatMobile(id, type) {
                console.log(`Attempting to open mobile chat for ${type} with ID: ${id}`);
                const chatListMobile = document.querySelector('.chat-list-mobile');
                const chattingPage = document.querySelector('#chatting-page-mobile');
                
                if (!chatListMobile || !chattingPage) {
                    console.error("Chat list mobile or chatting page not found! Chat List Mobile:", chatListMobile, "Chatting Page:", chattingPage);
                    return;
                }

                console.log("Hiding chat list and showing chatting page...");
                chatListMobile.classList.add('hidden');
                chattingPage.classList.remove('hidden');
                chattingPage.dataset.chatId = id;
                chattingPage.dataset.chatType = type;

                const headerImg = document.querySelector('#chat-header-img-mobile');
                const headerName = document.querySelector('#chat-header-name-mobile');
                const receiverIdInput = document.querySelector('#receiver-id-mobile');
                const groupIdInput = document.querySelector('#group-id-mobile');
                const messagesContainer = document.querySelector('#chat-messages-mobile');

                if (!headerImg || !headerName || !receiverIdInput || !groupIdInput || !messagesContainer) {
                    console.error("Chat header elements or messages container for mobile not found! Header Img:", headerImg, "Header Name:", headerName, "Receiver ID:", receiverIdInput, "Group ID:", groupIdInput, "Messages Container:", messagesContainer);
                    return;
                }

                console.log("Setting mobile chat header details...");
                if (type === 'user') {
                    const user = usersList.find(u => u.id == parseInt(id));
                    if (user) {
                        console.log("User found:", user);
                        headerImg.src = user.profile_pic ? `/uploads/profile_pics/${user.profile_pic}` : '/static/images/default_profile.jpg';
                        headerName.textContent = user.username;
                        receiverIdInput.value = id;
                        groupIdInput.value = '';
                    } else {
                        console.error(`User with ID ${id} not found in usersList:`, usersList);
                        return;
                    }
                } else {
                    const group = groupsList.find(g => g.id == parseInt(id));
                    if (group) {
                        console.log("Group found:", group);
                        headerImg.src = '/static/images/group_icon.png';
                        headerName.textContent = group.name + (group.is_channel ? ' (Channel)' : '');
                        receiverIdInput.value = '';
                        groupIdInput.value = id;
                    } else {
                        console.error(`Group with ID ${id} not found in groupsList:`, groupsList);
                        return;
                    }
                }

                console.log("Fetching messages for mobile chat...");
                fetch(`/messaging?${type === 'user' ? 'user_id' : 'group_id'}=${id}&chat_type=${type}`)
                    .then(response => {
                        console.log("Fetch response status:", response.status);
                        if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
                        return response.text();
                    })
                    .then(html => {
                        console.log('Fetched HTML (Mobile):', html);
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const messages = doc.querySelectorAll('.message');
                        messagesContainer.innerHTML = '';
                        console.log("Messages found for mobile:", messages.length);
                        if (messages.length > 0) {
                            messages.forEach(message => {
                                console.log("Processing message for mobile:", message);
                                const messageDiv = document.createElement('div');
                                messageDiv.classList.add('message', message.classList.contains('sent') ? 'sent' : 'received', 'mb-4', 'max-w-[70%]', 'p-3', 'rounded-lg', 'relative', 'transition-opacity', 'duration-300');
                                messageDiv.setAttribute('data-id', message.dataset.id || '');
                                const content = message.querySelector('div') ? message.querySelector('div').innerText : 'No content';
                                const timestamp = message.querySelector('.timestamp') ? message.querySelector('.timestamp').innerText : '';
                                messageDiv.innerHTML = `
                                    <div>${content}</div>
                                    <div class="timestamp text-xs text-gray-500 absolute bottom-[-1.5rem] right-2">${timestamp}${message.classList.contains('edited') ? ' (Edited)' : ''}</div>
                                    ${message.classList.contains('sent') ? `
                                        <div class="message-actions flex gap-2 mt-2 opacity-0 transition-opacity duration-300">
                                            <button onclick="editMessage(${message.dataset.id})" class="bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-500">Edit</button>
                                            <select onchange="setDisappearTimer(${message.dataset.id}, this.value)" class="bg-gray-600 text-white px-2 py-1 rounded">
                                                <option value="0">No Timer</option>
                                                <option value="10">10s</option>
                                                <option value="60">1min</option>
                                                <option value="3600">1hr</option>
                                            </select>
                                        </div>
                                    ` : ''}
                                `;
                                messagesContainer.appendChild(messageDiv);
                            });
                        } else {
                            console.log("No messages found for mobile, showing default message...");
                            messagesContainer.innerHTML = '<div class="text-gray-400 text-center">No messages yet, bhai! Start chatting! ðŸ˜Ž</div>';
                        }
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;

                        const room = groupIdInput.value ? `group_${groupIdInput.value}` : `chat_${Math.min(current_user_id, parseInt(receiverIdInput.value))}_${Math.max(current_user_id, parseInt(receiverIdInput.value))}`;
                        console.log(`Joining room (Mobile): ${room}`);
                        socket.emit('join', { room: room });
                    })
                    .catch(error => {
                        console.error('Error fetching messages (Mobile):', error.message);
                        messagesContainer.innerHTML = `<div class="text-red-500 text-center">Error loading messages, bhai! ðŸ˜… ${error.message}</div>`;
                    });
            }

            function backToChatList() {
                const chattingPage = document.querySelector('#chatting-page-mobile');
                const chatListMobile = document.querySelector('.chat-list-mobile');
                if (chattingPage && chatListMobile) {
                    console.log("Back to chat list clicked!");
                    chattingPage.classList.add('hidden');
                    chatListMobile.classList.remove('hidden');
                } else {
                    console.error("Chatting page or chat list mobile not found!");
                }
            }

            function sendMessage(event) {
                event.preventDefault();
                const isMobile = !event.target.id.includes('pc');
                const receiverIdInput = document.querySelector(`#receiver-id-${isMobile ? 'mobile' : 'pc'}`);
                const groupIdInput = document.querySelector(`#group-id-${isMobile ? 'mobile' : 'pc'}`);
                const messageInput = document.querySelector(`#message-content-${isMobile ? 'mobile' : 'pc'}`);

                if (!receiverIdInput || !groupIdInput || !messageInput) {
                    console.error("Message input elements not found!");
                    return;
                }

                const receiverId = receiverIdInput.value;
                const groupId = groupIdInput.value;
                const content = messageInput.value.trim();
                if (!content) return;

                console.log("Sending message:", content);
                socket.emit('send_message', {
                    receiver_id: receiverId,
                    group_id: groupId,
                    content: content,
                    content_type: 'text'
                });

                messageInput.value = '';
            }

            function editMessage(messageId) {
                const messageDiv = document.querySelector(`.message[data-id="${messageId}"]`);
                if (!messageDiv) {
                    console.error(`Message with ID ${messageId} not found!`);
                    return;
                }

                const content = messageDiv.querySelector('div').innerText;
                const newContent = prompt("Edit your message:", content);
                if (newContent && newContent !== content) {
                    console.log(`Editing message ID ${messageId} with new content: ${newContent}`);
                    fetch(`/edit_message/${messageId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `content=${encodeURIComponent(newContent)}`
                    }).then(response => response.json()).then(data => {
                        if (data.message) {
                            alert(data.message);
                        } else {
                            alert(data.error);
                        }
                    }).catch(error => {
                        console.error("Error editing message:", error);
                        alert("Error editing message, bhai! ðŸ˜…");
                    });
                }
            }

            function setDisappearTimer(messageId, timer) {
                console.log(`Setting disappear timer for message ID ${messageId} to ${timer} seconds`);
                fetch(`/set_disappear_timer/${messageId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `timer=${timer}`
                }).then(response => response.json()).then(data => {
                    if (data.message) {
                        alert(data.message);
                    } else {
                        alert(data.error);
                    }
                }).catch(error => {
                    console.error("Error setting disappear timer:", error);
                    alert("Error setting timer, bhai! ðŸ˜…");
                });
            }

            function muteChat() {
                alert('Chat muted!');
            }

            function blockChat() {
                alert('Chat blocked!');
            }

            // Add event listeners dynamically
            const chatMessagesPc = document.getElementById('chat-messages-pc');
            const chatMessagesMobile = document.getElementById('chat-messages-mobile');

            // PC Chat Items
            const pcChatItems = document.querySelectorAll('.chat-list .chat-item');
            console.log("PC Chat Items found:", pcChatItems.length);
            pcChatItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log(`Chat item clicked with ID: ${item.dataset.id}, Type: ${item.dataset.type}`);
                    const id = item.dataset.id;
                    const type = item.dataset.type;
                    openChat(id, type);
                });
            });

            const pcGroupItems = document.querySelectorAll('.group-list .group-item:not(.create-group)');
            console.log("PC Group Items found:", pcGroupItems.length);
            pcGroupItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log(`Group item clicked with ID: ${item.dataset.id}, Type: ${item.dataset.type}`);
                    const id = item.dataset.id;
                    const type = item.dataset.type;
                    openChat(id, type);
                });
            });

            // Mobile Chat Items
            const mobileChatItems = document.querySelectorAll('.chat-list-content .chat-item');
            console.log("Mobile Chat Items found:", mobileChatItems.length);
            mobileChatItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log(`Mobile chat item clicked with ID: ${item.dataset.id}, Type: ${item.dataset.type}`);
                    const id = item.dataset.id;
                    const type = item.dataset.type;
                    openChatMobile(id, type);
                });
            });

            const mobileGroupItems = document.querySelectorAll('.group-list-content .group-item:not(.create-group)');
            console.log("Mobile Group Items found:", mobileGroupItems.length);
            mobileGroupItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log(`Mobile group item clicked with ID: ${item.dataset.id}, Type: ${item.dataset.type}`);
                    const id = item.dataset.id;
                    const type = item.dataset.type;
                    openChatMobile(id, type);
                });
            });

            // Create Group Link
            document.querySelectorAll('.create-group').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log("Create group clicked!");
                    window.location.href = '{{ url_for('create_group') }}';
                });
            });

            socket.on('receive_message', (data) => {
                console.log("Received message:", data);
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', data.sender_id == current_user_id ? 'sent' : 'received', 'mb-4', 'max-w-[70%]', 'p-3', 'rounded-lg', 'relative', 'transition-opacity', 'duration-300');
                messageDiv.setAttribute('data-id', data.message_id);
                messageDiv.innerHTML = `
                    <div>${data.content}</div>
                    <div class="timestamp text-xs text-gray-500 absolute bottom-[-1.5rem] right-2">${data.timestamp}${data.edited ? ' (Edited)' : ''}</div>
                    ${data.sender_id == current_user_id ? `
                        <div class="message-actions flex gap-2 mt-2 opacity-0 transition-opacity duration-300">
                            <button onclick="editMessage(${data.message_id})" class="bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-500">Edit</button>
                            <select onchange="setDisappearTimer(${data.message_id}, this.value)" class="bg-gray-600 text-white px-2 py-1 rounded">
                                <option value="0">No Timer</option>
                                <option value="10">10s</option>
                                <option value="60">1min</option>
                                <option value="3600">1hr</option>
                            </select>
                        </div>
                    ` : ''}
                `;
                if (chatMessagesPc && !chatMessagesPc.classList.contains('hidden')) {
                    chatMessagesPc.appendChild(messageDiv);
                    chatMessagesPc.scrollTop = chatMessagesPc.scrollHeight;
                }
                if (chatMessagesMobile && !chatMessagesMobile.classList.contains('hidden')) {
                    chatMessagesMobile.appendChild(messageDiv);
                    chatMessagesMobile.scrollTop = chatMessagesMobile.scrollHeight;
                }

                if (data.sender_id != current_user_id) {
                    const room = data.group_id ? `group_${data.group_id}` : `chat_${Math.min(current_user_id, data.sender_id)}_${Math.max(current_user_id, data.sender_id)}`;
                    socket.emit('message_read', { message_id: data.message_id, room: room });
                }

                if (data.disappear_timer) {
                    setTimeout(() => {
                        messageDiv.remove();
                    }, data.disappear_timer * 1000);
                }
            });

            socket.on('message_edited', (data) => {
                console.log("Message edited:", data);
                const messageDiv = document.querySelector(`.message[data-id="${data.message_id}"]`);
                if (messageDiv) {
                    messageDiv.querySelector('div').innerText = data.content;
                    messageDiv.querySelector('.timestamp').innerText = `${messageDiv.querySelector('.timestamp').innerText.split(' (Edited)')[0]} (Edited)`;
                }
            });

            socket.on('disappear_timer_set', (data) => {
                console.log("Disappear timer set:", data);
                const messageDiv = document.querySelector(`.message[data-id="${data.message_id}"]`);
                if (messageDiv && data.timer > 0) {
                    setTimeout(() => {
                        messageDiv.remove();
                    }, data.timer * 1000);
                }
            });

            document.querySelectorAll('.message.sent').forEach(message => {
                message.addEventListener('mouseenter', () => {
                    const actions = message.querySelector('.message-actions');
                    if (actions) actions.classList.remove('opacity-0');
                });
                message.addEventListener('mouseleave', () => {
                    const actions = message.querySelector('.message-actions');
                    if (actions) actions.classList.add('opacity-0');
                });
            });
        });
    </script>
</body>
</html>
